<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="mxfda">
<title>Functional principal component analysis for spatial summary functions • mxfda</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Functional principal component analysis for spatial summary functions">
<meta property="og:description" content="mxfda">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">mxfda</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.1-1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/mx_fda.html">Defining an mxFDA object</a>
    <a class="dropdown-item" href="../articles/mx_fpca.html">Functional principal component analysis for spatial summary functions</a>
    <a class="dropdown-item" href="../articles/mx_funreg.html">Functional regression with spatial summary functions as covariates</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/julia-wrobel/mxfda/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Functional principal component analysis for spatial summary functions</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/julia-wrobel/mxfda/blob/HEAD/vignettes/mx_fpca.Rmd" class="external-link"><code>vignettes/mx_fpca.Rmd</code></a></small>
      <div class="d-none name"><code>mx_fpca.Rmd</code></div>
    </div>

    
    
<p>The <a href="https://github.com/julia-wrobel/mxfda/" class="external-link">mxfda</a> package contains tools for analyzing spatial
single-cell data using methods from functional data analysis. Analyses
for this package are executed and stored using an S4 object of class
<code>mxFDA</code>. This vignette outlines how to perform feature
extraction using functional principal component analysis and multilevel
functional principal component analysis. To set up an <code>mxFDA</code>
object from spatial single cell imaging data, calculate spatial summary
functions, and perform exploratory data analysis and visualization of
these spatial summary functions, see <code><a href="../articles/mx_fda.html">vignette("mx_fda")</a></code>. To
perform functional regression on spatial summary functions from
multiplex imaging data, see <code><a href="../articles/mx_funreg.html">vignette("mx_funreg")</a></code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/julia-wrobel/mxfda/" class="external-link">mxfda</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rpkgs.datanovia.com/ggpubr/" class="external-link">ggpubr</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="functional-data-notation">Functional data notation<a class="anchor" aria-label="anchor" href="#functional-data-notation"></a>
</h2>
<p>The basic unit of observation is the curve <span class="math inline">\(X_i(r)\)</span> for subjects <span class="math inline">\(i \in \ldots, I\)</span> in the cross-sectional
setting and <span class="math inline">\(X_{ij}(r)\)</span> for subject
<span class="math inline">\(i\)</span> at sample <span class="math inline">\(j \in \ldots, J_i\)</span> for the multilevel
structure, which occurs when there are multiple samples for each
subject. Methods for functional data are typically presented in terms of
continuous functions, but in practice data are observed on a discrete
grid, <span class="math inline">\(t\)</span>. In the
<a href="https://github.com/julia-wrobel/mxfda/" class="external-link">mxfda</a> package, <span class="math inline">\(X_{ij}(r)\)</span> is the spatial summary function
(for example, Ripley’s K) value at radius <span class="math inline">\(r\)</span> for sample <span class="math inline">\(j\)</span> from subject <span class="math inline">\(i\)</span>.</p>
</div>
<div class="section level2">
<h2 id="functional-principal-components-analysis-fpca">Functional principal components analysis (FPCA)<a class="anchor" aria-label="anchor" href="#functional-principal-components-analysis-fpca"></a>
</h2>
<div class="section level3">
<h3 id="background-on-fpca">Background on FPCA<a class="anchor" aria-label="anchor" href="#background-on-fpca"></a>
</h3>
<p>FPCA characterizes modes of variability by decomposing functional
observations into population level basis functions and subject-specific
scores. The basis functions have a clear interpretation, analogous to
that of PCA: the first basis function explains the largest direction of
variation, and each subsequent basis function describes less. The FPCA
model is typically written</p>
<p><span class="math display">\[
X_i(r) = \mu(r) + \sum_{k=1}^{K} c_{ik}\psi_{k}(r) + \epsilon_i(r)
\]</span></p>
<p>where <span class="math inline">\(\mu(r)\)</span> is the population
mean, <span class="math inline">\(\psi_{k}(r)\)</span> are a set of
orthonormal population-level functional principal components, <span class="math inline">\(c_{ik}\)</span> are subject-specific scores with
mean zero and variance <span class="math inline">\(\lambda_k\)</span>,
and <span class="math inline">\(\epsilon_i(r)\)</span> are residual
curves. Estimated functional principal components <span class="math inline">\(\widehat{\psi}_1(r), \widehat{\psi}_2(r), \ldots,
\widehat{\psi}_{K}(r)\)</span> and corresponding variances <span class="math inline">\(\widehat{\lambda}_1 \geq \widehat{\lambda}_2 \geq
\ldots \geq \widehat{\lambda}_K\)</span> are obtained from a truncated
Karhunen-Lo`eve decomposition of the sample covariance <span class="math inline">\(\widehat{\Sigma}(s,t) =
\widehat{\mbox{Cov}}(Y_i(s), X_i(r))\)</span>. The truncation lag <span class="math inline">\(K\)</span> is often chosen so that the resulting
approximation accounts for at least 95% of observed variance (<span class="citation">Wrobel et al. (2016)</span>).</p>
<p>Conceptually, functional principal components can be thought of as
patterns in the data that explain the most variance, and scores <span class="math inline">\(c_{ik}\)</span> are weights that describe how much
each functional principal component contributes to the shape of a given
subject’s spatial summary function.</p>
</div>
<div class="section level3">
<h3 id="implementing-fpca">Implementing FPCA<a class="anchor" aria-label="anchor" href="#implementing-fpca"></a>
</h3>
<div class="section level4">
<h4 id="load-and-visualize-data">Load and visualize data<a class="anchor" aria-label="anchor" href="#load-and-visualize-data"></a>
</h4>
<p>Here we load data from the <a href="https://bioconductor.org/packages/release/data/experiment/html/VectraPolarisData.html" class="external-link">VectraPolarisData</a>
ovarian cancer dataset, which contains tumor microarray data for 128
women with high-grade serous ovarian cancer, where univariate
nearest-neighbor G-functions for immune cells have already been
extracted. This data has been modified, but the original data and
experiment are described in <span class="citation">Steinhart et al.
(2021)</span>. Each subject has one image.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"ovarian_FDA"</span><span class="op">)</span></span>
<span><span class="va">ovarian_FDA</span></span>
<span><span class="co">#&gt; mxFDA Object:</span></span>
<span><span class="co">#&gt;  Subjects: 128</span></span>
<span><span class="co">#&gt;  Samples: 128</span></span>
<span><span class="co">#&gt;  Has spatial data</span></span>
<span><span class="co">#&gt;  Univariate Summaries: Gest</span></span>
<span><span class="co">#&gt;  Bivariate Summaries: None</span></span>
<span><span class="co">#&gt; FPCs not yet calculated</span></span>
<span><span class="co">#&gt; MFPCs not yet calculated</span></span>
<span><span class="co">#&gt; FCMs not yet calculated</span></span>
<span><span class="co">#&gt; MFCMs not yet calculated</span></span>
<span><span class="co">#&gt; Scalar on Functional Regression not calculated</span></span></code></pre></div>
<p>These functions are visualized below.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ovarian_FDA</span>, y <span class="op">=</span> <span class="st">"fundiff"</span>, what <span class="op">=</span> <span class="st">"uni g"</span>, sampleID <span class="op">=</span> <span class="st">"patient_id"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, color <span class="op">=</span> <span class="st">"red"</span>, linetype <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> </span></code></pre></div>
<p><img src="mx_fpca_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
<p>Values above the dotted red line are interpreted as having a higher
probability of observing a neighboring immune cell at radius <span class="math inline">\(r\)</span> than would be expected under complete
spatial randomness (CSR). Conversely, values below the dotted line
exhibit lower probability of observing a neighboring immune cell than
expected under CSR.</p>
</div>
<div class="section level4">
<h4 id="run-and-visualize-fpca">Run and visualize FPCA<a class="anchor" aria-label="anchor" href="#run-and-visualize-fpca"></a>
</h4>
<p>Below we run FPCA on these G-function curves, using the
<code><a href="../reference/run_fpca.html">run_fpca()</a></code> function, and store these results in the
<code>mxFDAobject</code> called <code>ovarian_FDA</code>. The argument
<code>metric</code> is used to specify which spatial summary function to
estimate FPCA for - in this case <code>"uni g"</code> specifies the
univariate G function, <code>r</code> denotes which variable specifies
the radius, and <code>value</code> denotes which value are the values of
the spatial summary function. The argument <code>pve</code> takes a
number from 0 to 1, and specifies the percent variance explained by the
FPCA decomposition. For example, if <code>pve = 0.98</code> is selected,
the resulting FPCA will return the number of FPCs that explain 98% of
variance in the data.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ovarian_FDA</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_fpca.html">run_fpca</a></span><span class="op">(</span><span class="va">ovarian_FDA</span>, </span>
<span>                        metric <span class="op">=</span> <span class="st">"uni g"</span>, </span>
<span>                        r <span class="op">=</span> <span class="st">"r"</span>, </span>
<span>                        value <span class="op">=</span> <span class="st">"fundiff"</span>,</span>
<span>                        pve <span class="op">=</span> <span class="fl">.95</span><span class="op">)</span></span>
<span><span class="co">#&gt; 128 sample have &gt;= 4 values for FPCA; removing 0 samples</span></span></code></pre></div>
<p>Note that the summary of this object now shows the number of
functional principal components (FPCs) that have been calculated:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">ovarian_FDA</span><span class="op">)</span></span>
<span><span class="co">#&gt; mxFDA Object:</span></span>
<span><span class="co">#&gt;  Subjects: 128</span></span>
<span><span class="co">#&gt;  Samples: 128</span></span>
<span><span class="co">#&gt;  Has spatial data</span></span>
<span><span class="co">#&gt;  Univariate Summaries: Gest</span></span>
<span><span class="co">#&gt;  Bivariate Summaries: None</span></span>
<span><span class="co">#&gt; FPCs Calculated:</span></span>
<span><span class="co">#&gt;  Gest: 4 FPCs describe 96.9% variance</span></span>
<span><span class="co">#&gt; MFPCs not yet calculated</span></span>
<span><span class="co">#&gt; FCMs not yet calculated</span></span>
<span><span class="co">#&gt; MFCMs not yet calculated</span></span>
<span><span class="co">#&gt; Scalar on Functional Regression not calculated</span></span></code></pre></div>
<p>The FPCA results are stored in the <code>functional_pca</code> slot
of the <code>ovarian_FDA</code> object. To access this slot directly and
view the extracted summary functions, type:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ovarian_FDA</span><span class="op">@</span><span class="va">functional_pca</span></span></code></pre></div>
<p>We can visualize the results of FPCA using the <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code>
function (see <code><a href="../reference/plot.mxFDA.html">?plot.mxFDA</a></code> for details). The output of
<code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code> is a <a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a> object which can then be
easily added to/manipulated as any ggplot plot would. Below we plot the
first two functional principal components from our FPCA analysis of the
G summary functions.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">p1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ovarian_FDA</span>, what <span class="op">=</span> <span class="st">'uni g fpca'</span>, pc_choice <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ovarian_FDA</span>, what <span class="op">=</span> <span class="st">'uni g fpca'</span>, pc_choice <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rpkgs.datanovia.com/ggpubr/reference/ggarrange.html" class="external-link">ggarrange</a></span><span class="op">(</span><span class="va">p1</span>, <span class="va">p2</span>, nrow <span class="op">=</span> <span class="fl">1</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="mx_fpca_files/figure-html/fpc_plots-1.png" width="960"></p>
<p>The plots above show <span class="math inline">\(\hat{\mu}(r)\pm
\sqrt{\hat{\lambda}_1\hat{\psi_k}(t)}\)</span> for the first and second
FPC. The black line in each plot is the mean of the data- this shows
that the peak in probability of observing a neighboring immune cell
occurs, on average, at about radius <span class="math inline">\(r =
12\)</span>. In these plots, the blue and red lines represent one
standard deviation of the FPC added (blue) or subtracted (red) from the
population mean. For example in the plot for FPC 1, we can interpret the
pattern of this FPC as a shift up or down from the population mean.
Subjects who have a high score, <span class="math inline">\(c_{i1}\)</span> for FPC 1 have, across radii, a
larger probability of observing a neighboring immune cell than average
in the dataset. This pattern explains 76.2% of variance in the data.</p>
<p>We can further explore the results of FPCA interactively using the
<code>{refund.shiny}</code> package from <span class="citation">Wrobel
et al. (2016)</span>. Execute the code below to launch a Shiny app with
interactive plots.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">G_fpca</span> <span class="op">=</span> <span class="fu"><a href="../reference/extract_fpca_object.html">extract_fpca_object</a></span><span class="op">(</span><span class="va">ovarian_FDA</span>,</span>
<span>                             what <span class="op">=</span> <span class="st">"uni g fpca"</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">refund.shiny</span><span class="op">)</span></span>
<span><span class="fu">plot_shiny</span><span class="op">(</span><span class="va">G_fpca</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
</div>
<div class="section level2">
<h2 id="multilevel-functional-principal-components-analysis-mfpca">Multilevel functional principal components analysis (MFPCA)<a class="anchor" aria-label="anchor" href="#multilevel-functional-principal-components-analysis-mfpca"></a>
</h2>
<div class="section level3">
<h3 id="mfpca-background">MFPCA Background<a class="anchor" aria-label="anchor" href="#mfpca-background"></a>
</h3>
<p>Multilevel functional principal components analysis (MFPCA) extends
the ideas of FPCA to functional data with a multilevel structure. In the
case of multiplex imaging data, this structure arises from multiple
samples or ROIs for each subject. MFPCA models the within-subject
correlation induced by repeated measures as well as the between-subject
correlation modeled by classic FPCA. This leads to a two-level FPC
decomposition, where level 1 concerns subject-specific effects and level
2 concerns sample-specific effects. Population-level basis functions and
subject-specific scores are calculated for both levels (<span class="citation">Di et al. (2009)</span>, <span class="citation">Cui et
al. (2023)</span>). The MFPCA model is:</p>
<p><span class="math display">\[
X_{ij}(r) = \mu(r)  +
\sum_{k_1=1}^{K_1}    c_{ik}^{(1)}\psi_{k}^{(1)}(r) +
\sum_{k_2=1}^{K_2}c^{(2)}_{ijk}\psi_{k}^{(2)}(r) + \epsilon_{ij}(r)
\]</span></p>
<p> where <span class="math inline">\(\mu(r)\)</span> is the population
mean, <span class="math inline">\(\psi_{k}^{(1)}(r)\)</span> and <span class="math inline">\(\psi_{k}^{(2)}(r)\)</span> are the functional
principal components for levels 1 and 2, respectively, and <span class="math inline">\(c_{ik}^{(1)}\)</span> and <span class="math inline">\(c^{(2)}_{ijk}\)</span> are the subject-specific
and subject-sample-specific scores. <span class="math inline">\(K_1\)</span> and <span class="math inline">\(K_2\)</span> represent the number of FPCs for
levels 1 and 2, respectively.</p>
</div>
<div class="section level3">
<h3 id="implementing-mfpca">Implementing MFPCA<a class="anchor" aria-label="anchor" href="#implementing-mfpca"></a>
</h3>
<p>For MFPCA we will use the non-small cell lung carcinoma data, since
we need multiple samples per subject. Below we extract the univariate K
functions from the lung data.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">lung_df</span><span class="op">)</span></span>
<span></span>
<span><span class="va">clinical</span> <span class="op">=</span> <span class="va">lung_df</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">image_id</span>, <span class="va">patient_id</span>, <span class="va">patientImage_id</span>, <span class="va">gender</span>, <span class="va">age</span>, <span class="va">survival_days</span>, <span class="va">survival_status</span>, <span class="va">stage</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">spatial</span> <span class="op">=</span> <span class="va">lung_df</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">image_id</span>, <span class="op">-</span><span class="va">gender</span>, <span class="op">-</span><span class="va">age</span>, <span class="op">-</span><span class="va">survival_days</span>, <span class="op">-</span><span class="va">survival_status</span>, <span class="op">-</span><span class="va">stage</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mxFDAobject</span> <span class="op">=</span> <span class="fu"><a href="../reference/make_mxfda.html">make_mxfda</a></span><span class="op">(</span>metadata <span class="op">=</span> <span class="va">clinical</span>,</span>
<span>                         spatial <span class="op">=</span> <span class="va">spatial</span>,</span>
<span>                         subject_key <span class="op">=</span> <span class="st">"patient_id"</span>,</span>
<span>                         sample_key <span class="op">=</span> <span class="st">"patientImage_id"</span></span>
<span>                         <span class="op">)</span></span>
<span></span>
<span><span class="va">mxFDAobject</span> <span class="op">=</span> <span class="fu"><a href="../reference/extract_summary_functions.html">extract_summary_functions</a></span><span class="op">(</span><span class="va">mxFDAobject</span>, </span>
<span>                                        extract_func <span class="op">=</span> <span class="va">univariate</span>,</span>
<span>                                        summary_func <span class="op">=</span> <span class="va">Kest</span>,</span>
<span>                                        r_vec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">100</span>, by <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>                                        edge_correction <span class="op">=</span> <span class="st">"iso"</span>,</span>
<span>                                        markvar <span class="op">=</span> <span class="st">"immune"</span>,</span>
<span>                                        mark1 <span class="op">=</span> <span class="st">"immune"</span><span class="op">)</span></span></code></pre></div>
<p>These K-functions are visualized below.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mxFDAobject</span>, y <span class="op">=</span> <span class="st">"fundiff"</span>, what <span class="op">=</span> <span class="st">"uni k"</span>, sampleID <span class="op">=</span> <span class="st">"patientImage_id"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, color <span class="op">=</span> <span class="st">"red"</span>, linetype <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Removed 48 rows containing missing values or values outside the scale range</span></span>
<span><span class="co">#&gt; (`geom_line()`).</span></span></code></pre></div>
<p><img src="mx_fpca_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<div class="section level4">
<h4 id="run-and-visualize-mfpca">Run and visualize MFPCA<a class="anchor" aria-label="anchor" href="#run-and-visualize-mfpca"></a>
</h4>
<p>Below we run MFPCA on these K-function curves, using the
<code><a href="../reference/run_mfpca.html">run_mfpca()</a></code> function, and store these results in the
<code>mxFDAobject</code> lung cancer data object. Other arguments are
the same as the <code><a href="../reference/run_fpca.html">run_fpca()</a></code> function. From the summary of
the object we see that 2 level 1 FPCs and 2 level 2 FPCs were
calculated.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mxFDAobject</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_mfpca.html">run_mfpca</a></span><span class="op">(</span><span class="va">mxFDAobject</span>, </span>
<span>                         metric <span class="op">=</span> <span class="st">"uni k"</span>, </span>
<span>                         r <span class="op">=</span> <span class="st">"r"</span>, </span>
<span>                         value <span class="op">=</span> <span class="st">"fundiff"</span>,</span>
<span>                         pve <span class="op">=</span> <span class="fl">.99</span><span class="op">)</span></span>
<span><span class="co">#&gt; 246 sample have &gt;= 4 values for FPCA; removing 1 samples</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(patient_id)`</span></span>
<span></span>
<span><span class="va">mxFDAobject</span></span>
<span><span class="co">#&gt; mxFDA Object:</span></span>
<span><span class="co">#&gt;  Subjects: 50</span></span>
<span><span class="co">#&gt;  Samples: 247</span></span>
<span><span class="co">#&gt;  Has spatial data</span></span>
<span><span class="co">#&gt;  Univariate Summaries: Kest</span></span>
<span><span class="co">#&gt;  Bivariate Summaries: None</span></span>
<span><span class="co">#&gt; FPCs not yet calculated</span></span>
<span><span class="co">#&gt; MFPCs Calculated:</span></span>
<span><span class="co">#&gt;  Kest: 1 Level1 MFPCs and 3 Level2 MFPCs explain 99.6% variance</span></span>
<span><span class="co">#&gt; FCMs not yet calculated</span></span>
<span><span class="co">#&gt; MFCMs not yet calculated</span></span>
<span><span class="co">#&gt; Scalar on Functional Regression not calculated</span></span></code></pre></div>
<p>We can also visualize the results of MFPCA using the
<code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code> function (see <code><a href="../reference/plot.mxFDA.html">?plot.mxFDA</a></code> for details).
Below we plot the first FPC for level 1 and the first FPC for level
2.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mxFDAobject</span>, what <span class="op">=</span> <span class="st">'uni k mfpca'</span>, level1 <span class="op">=</span> <span class="fl">1</span>, level2 <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rpkgs.datanovia.com/ggpubr/reference/ggarrange.html" class="external-link">ggarrange</a></span><span class="op">(</span>plotlist <span class="op">=</span> <span class="va">p</span>, nrow <span class="op">=</span> <span class="fl">1</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="mx_fpca_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
<p>The left plot shows <span class="math inline">\(\hat{\mu}(r)\pm
\sqrt{\hat{\lambda}_1^{(1)}}\hat{\psi_1}^{(1)}(t)\)</span>, and
indicates that the first level 1 FPC explains essentially a shift up or
down from the population mean. Subjects who have a high score, <span class="math inline">\(c_{i1}\)</span> for FPC 1 have, across radii, have
more spatial clustering of immune cells than average in the dataset. The
right plot shows <span class="math inline">\(\hat{\mu}(r)\pm
\sqrt{\hat{\lambda}_1^{(2)}}\hat{\psi}_1^{(2)}(t)\)</span>. This plot
shows the pattern explained by FPC 1 from level 2. Essentially, it is
the main pattern of variation explain differences across samples within
a given subjects and shows that within a subject, differences are
primarily driven by some images having higher overall K-function values
and some being lower.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-cui2023fast" class="csl-entry">
Cui, Erjia, Ruonan Li, Ciprian M Crainiceanu, and Luo Xiao. 2023.
<span>“Fast Multilevel Functional Principal Component Analysis.”</span>
<em>Journal of Computational and Graphical Statistics</em> 32 (2):
366–77.
</div>
<div id="ref-di2009multilevel" class="csl-entry">
Di, Chong-Zhi, Ciprian M Crainiceanu, Brian S Caffo, and Naresh M
Punjabi. 2009. <span>“Multilevel Functional Principal Component
Analysis.”</span> <em>The Annals of Applied Statistics</em> 3 (1): 458.
</div>
<div id="ref-steinhart2021spatial" class="csl-entry">
Steinhart, Benjamin, Kimberly R Jordan, Jaidev Bapat, Miriam D Post,
Lindsay W Brubaker, Benjamin G Bitler, and Julia Wrobel. 2021.
<span>“The Spatial Context of Tumor-Infiltrating Immune Cells Associates
with Improved Ovarian Cancer Survival.”</span> <em>Molecular Cancer
Research</em> 19 (12): 1973–79.
</div>
<div id="ref-wrobel2016interactive" class="csl-entry">
Wrobel, Julia, So Young Park, Ana Maria Staicu, and Jeff Goldsmith.
2016. <span>“Interactive Graphics for Functional Data Analyses.”</span>
<em>Stat</em> 5 (1): 108–18.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Julia Wrobel, Alex Soupir.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
