---
title: "mx_fda"
output: rmarkdown::html_vignette
bibliography: references.bib
vignette: >
  %\VignetteIndexEntry{mx_fda}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  figs.out = "../figures"
)
```



This vignette describes the `mxfda` package for analyzing single-cell multiplex imaging data using tools from functional data analysis. Analyses for this package are executed and stored using an S4 object of class `mxFDA`. This vignette outlines how to set up an `mxFDA` object from spatial single cell imaging data, how to calculate spatial summary functions, and exploratory data analysis and visualization of these spatial summary functions. Details on how to perform downstream analysis and feature extraction using functional principal components analysis can be found in the separate vignette `mx_fpca`. To perform functional regression on spatial summary functions from multiplex imaging data, see the `mx_funreg` vignette.


```{r setup}
library(mxfda)
library(tidyverse)
library(patchwork)
```



# Background on functional data analysis for multiplex imaging data

What are the goals of mxfda package?

* Make it easier to analyze spatial relationships of cells in multiplex images
* Use spatial summary functions of point processes to characterize univariate / bivariate clustering
* Relate spatial summary functions to patient level outcomes
* Explain how to interpret output from functional data analyses
* Use completely open source data 

* Add references here to relevant papers. Need to add to the references.bib file then can cite by:

@wrobel_2019

# VectraPolarisData 

All examples in this vignette use data from the [VectraPolarisData](https://bioconductor.org/packages/release/data/experiment/html/VectraPolarisData.html) package on Bioconductor's ExperimentHub.  This package contains data from two multiplex imaging experiments conducted at the University of Colorado Anschutz Medical Campus. A shortcourse on single-cell multiplex imaging using these data is available [here](http://juliawrobel.com/MI_tutorial/MI_Data.html).

* Describe the two datasets
* Say this vignette will focus on the lung data
* Data has been preprocessed and stored directly in the package


This data contains (number of subjects, images per subject, number of cells). Load the data.

```{r}
# load processed lung cancer data
data(lung_df)
```


# Setting up the mxfun object

Alex to fill in these details.


Make FDAobject

```{r object}
clinical = lung_df %>%
  select(image_id, patient_id, patientImage_id, gender, age, survival_days, survival_status, stage) %>%
  distinct()

spatial = lung_df %>%
  select(-image_id, -gender, -age, -survival_days, -survival_status, -stage)

mxFDAobject = make_mxfda(metadata = clinical,
                         spatial = spatial,
                         key = "patient_id")
```




# Spatial summary functions based on point processes

Use text from somewhere else here. Talk about K, g, and G and point to links

## Univariate summary functions

Use text from somewhere else here to describe what these are.


Below we calculate univariate Ripley's K for all immune cells in each image. Describe that it is using spatstat under the hood. These can be calculated with our package or spatialTIME. Options for the edge correction when using Ripley's K include `"border", "isotropic", "Ripley", "translate"`.  See `spatstat.core::Kest` for more details. Below we calculate the K function across a range of radii from 0 to 300 and use the isotropic ("iso") edge correction.  The `analysis_vars` argument retains variables that may be used in downstream analysis



```{r univariate_k}
mxFDAobject = extract_summary_functions(mxFDAobject, "patientImage_id",
                                        extract_func = extract_univariate,
                                        summary_func = Kest,
                                        r_vec = seq(0, 100, by = 1),
                                        edge_correction = "iso",
                                        markvar = "immune",
                                        mark1 = "immune")
```

COMMENT ON THESE PLOTS

```{r}
plot(mxFDAobject, y = "fundiff", what = "uni k", sampleID = "patientImage_id") +
  geom_hline(yintercept = 0, color = "red", linetype = 2)
```


SAY WHAT YOU DO DIFFERENT TO GET L OR G

```{r}
rm(Gcrossdf)
```

## Bivariate summary functions

Use if you want to do bivariate. We will look at relationship between T-cells and macrophages. There are a few images that have fewer than 5 T-cells or macrophages, which makes estimation less stable for those images.

Below we calculate the bivariate G function, but replace Lcross or Kcross to do L or K bivariate functions


```{r}
lung_df = lung_df %>%
  mutate(phenotype = case_when(phenotype_cd8 == "CD8+" ~ "T-cell",
                               phenotype_cd14 == "CD14+" ~ "macrophage",
                               TRUE ~ "other"),
         phenotype = factor(phenotype))


lung_df %>%
  group_by(patientImage_id) %>%
  count(phenotype) %>%
  ungroup() %>%
  filter(phenotype != "other") %>%
  group_by(phenotype) %>%
  summarize(sum(n < 5))
```


Automatically removes images that do not have at least 1 cell of each type
  * Is this behavior we actually want?

```{r}
spatial = lung_df %>%
  select(-image_id, -gender, -age, -survival_days, -survival_status, -stage)

mxFDAobject = make_mxfda(metadata = clinical,
                         spatial = spatial,
                         key = "patient_id")
```

Running Gcross on T-cells and macrophages

```{r}
mxFDAobject = extract_summary_functions(mxFDAobject, "patientImage_id",
                summary_func = Gcross,
                extract_func = extract_bivariate,
                r_vec = seq(0, 100, by = 1),
                edge_correction = "rs",
                markvar = "phenotype",
                mark1 = "T-cell",
                mark2 = "macrophage")

```


```{r}
plot(mxFDAobject, y = "fundiff", what = "bi g", sampleID = "patientImage_id") +
  geom_hline(yintercept = 0, color = "red", linetype = 2)
```

# Exploring the S4 object

Alex to add other details of neat things he has here.


# SpatialTIME

Add example for converting spatialTIME to long format for use with mxfda.

# Calculating and adding your own spatial summary function

Add example of how to do this.


# References
